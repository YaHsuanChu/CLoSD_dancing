# AIST++ Motion Evaluation Script

Evaluate motion generation quality on AIST++ dataset, comparing generated motions against ground truth.

## Usage

```bash
# Evaluate generated motions
python closd/diffusion_planner/eval/eval_aistpp_external.py \
    --external_results_file <path_to_npy_file>

# Evaluate ground truth motions (baseline)
python closd/diffusion_planner/eval/eval_aistpp_external.py \
    --external_results_file <path_to_npy_file> \
    --eval_gt
```

## Arguments

| Argument | Default | Description |
|----------|---------|-------------|
| `--external_results_file` | (required) | Path to `.npy` or `.pkl` file with generated motions |
| `--eval_gt` | False | Evaluate ground truth motions instead of generated |
| `--device` | 0 | GPU device ID |
| `--seed` | 10 | Random seed |
| `--fps` | 60 | Motion FPS (AIST++ uses 60) |
| `--beat_sigma` | 0.08 | Gaussian tolerance for beat alignment (seconds) |
| `--smooth_kinematic` | False | Apply smoothing filter to kinematic speed |

## Metrics

| Metric | Description | Better |
|--------|-------------|--------|
| **FID** | Fr?chet Inception Distance between generated and GT motion distributions | Lower ¡õ |
| **Diversity** | Variance of motion features | Higher ¡ô |
| **BeatAlign** | How well kinematic beats align with music beats (0-1) | Higher ¡ô |
| **SkatingRatio** | Ratio of frames with foot skating artifact | Lower ¡õ |
| **FootSliding** | Total foot sliding distance (mm) | Lower ¡õ |
| **Penetration** | Foot penetration into ground (mm) | Lower ¡õ |
| **Floating** | Distance feet float above ground (mm) | Lower ¡õ |

## Beat Alignment (BAS)

The Beat Alignment Score follows the **AIST++ standard**:

1. **Music Beats**: Extracted from audio waveform using `librosa.beat.beat_track`
2. **Kinematic Beats**: Local minima of body velocity (velocity dips when dancer "hits" a beat)
3. **Score**: For each kinematic beat, find distance to nearest music beat, apply Gaussian kernel

Formula:
$$\text{BAS} = \frac{1}{|B_{dance}|} \sum_{t_d \in B_{dance}} \exp\left(-\frac{(t_d - t_{music}^{nearest})^2}{2\sigma^2}\right)$$

> **Note**: This is a **precision** metric - dancers can skip beats, but when they move, they should be on beat.

## Input File Formats

### `.npy` (from `generate_from_audio.py`)
```python
{
    "motion": np.ndarray,           # (N, T, 263) generated motions
    "gt_motion": np.ndarray,        # (N, T, 263) ground truth motions
    "lengths": np.ndarray,          # (N,) motion lengths
    "audio_waveforms": List[Dict],  # [{waveform, sample_rate}, ...] paired audio
}
```

### `.pkl` (from CLoSD `run.py`)
```python
{
    "motion": np.ndarray,  # (N, T, 263) generated motions
    "length": np.ndarray,  # (N,) motion lengths (note: "length" not "lengths")
}
```

## Example Output

```
=== AIST++ external eval ===
external_results_file: /path/to/generated_motions.npy
num_samples: 1000
FID: 19.1027
Diversity: 4.4411
BeatAlign: 0.3338 (computed on 1000 samples with audio)
SkatingRatio(mean): 0.0547
FootSliding(mm): 2.0688
Penetration(mm): 1.2183
Floating(mm): 231.1720
```

## Typical Results

| Metric | Generated | Ground Truth |
|--------|-----------|--------------|
| FID | ~19 | ~0.05 |
| Diversity | ~4.4 | ~5.3 |
| BeatAlign | ~0.33 | ~0.33 |
| SkatingRatio | ~0.05 | ~0.008 |
| FootSliding(mm) | ~2 | ~0.05 |
| Penetration(mm) | ~1.2 | ~0 |
| Floating(mm) | ~230 | ~60 |

conda activate closd && CUDA_VISIBLE_DEVICES=5 python closd/diffusion_planner/eval/eval_aistpp_external.py --external_results_file /share3/saves/boson/image/CLoSD_dancing/output/CLoSD.pkl --beat_samples 1000
[WARN] lengths max (2877) > actual_motion_len (400), clamping
[WARN] No paired audio in npy file, using random audio from dataloader
[INFO] Loading 1000 audio samples for BeatAlign (fixed_len=400)
[DEBUG] _get_gt_batch_with_audio: calling get_dataset_loader...
Fetching 52 files: 100%|????????????????????????????????????????????| 52/52 [00:00<00:00, 26328.32it/s]
Data dependencies are cached at [/share2/huggingface/hub/models--guytevet--CLoSD/snapshots/de7106b947b6f70700b5320d1cd61fef4a9ebc9b]
[DEBUG] _get_gt_batch_with_audio: loader created, getting first batch...
[DEBUG] _get_gt_batch_with_audio: got batch!
[DEBUG] Dataloader done!
Fetching 52 files: 100%|????????????????????????????????????????????| 52/52 [00:00<00:00, 14878.49it/s]
Data dependencies are cached at [/share2/huggingface/hub/models--guytevet--CLoSD/snapshots/de7106b947b6f70700b5320d1cd61fef4a9ebc9b]
Loading Evaluation Model Wrapper (Epoch 11) Completed!!
[INFO] Loaded motion mean/std from closd/diffusion_planner/dataset
=== AIST++ external eval ===
external_results_file: /share3/saves/boson/image/CLoSD_dancing/output/CLoSD.pkl
num_samples: 1000
FID: 5.0655
Diversity: 3.5792
BeatAlign: 0.3727 (computed on 1000 samples with audio)
SkatingRatio(mean): 0.0176
FootSliding(mm): 0.0000
Penetration(mm): 0.0002
Floating(mm): 23.8992

conda activate closd && CUDA_VISIBLE_DEVICES=5 python closd/diffusion_planner/eval/eval_aistpp_external.py --external_results_file /share3/saves/boson/image/CLoSD_dancing/output/aistpp_concat_ng20/sample/generated_motions.npy
[INFO] Loaded 1000 paired audio waveforms from npy file
[INFO] Using 1000 paired audio waveforms for beat alignment
[DEBUG] _get_gt_batch_with_audio: calling get_dataset_loader...
Fetching 52 files: 100%|???????????????????????????????????????????????????????????????????????????????????????????????????????| 52/52 [00:00<00:00, 28447.09it/s]
Data dependencies are cached at [/share2/huggingface/hub/models--guytevet--CLoSD/snapshots/de7106b947b6f70700b5320d1cd61fef4a9ebc9b]
[DEBUG] _get_gt_batch_with_audio: loader created, getting first batch...
[DEBUG] _get_gt_batch_with_audio: got batch!
Fetching 52 files: 100%|???????????????????????????????????????????????????????????????????????????????????????????????????????| 52/52 [00:00<00:00, 16099.79it/s]
Data dependencies are cached at [/share2/huggingface/hub/models--guytevet--CLoSD/snapshots/de7106b947b6f70700b5320d1cd61fef4a9ebc9b]
Loading Evaluation Model Wrapper (Epoch 11) Completed!!
[INFO] Loaded motion mean/std from closd/diffusion_planner/dataset
=== AIST++ external eval ===
external_results_file: /share3/saves/boson/image/CLoSD_dancing/output/aistpp_concat_ng20/sample/generated_motions.npy
num_samples: 1000
FID: 16.1660
Diversity: 4.6198
BeatAlign: 0.3852 (computed on 1000 samples with audio)
SkatingRatio(mean): 0.0152
FootSliding(mm): 0.9039
Penetration(mm): 1.8671
Floating(mm): 249.7649

conda activate closd && CUDA_VISIBLE_DEVICES=5 python closd/diffusion_planner/eval/eval_aistpp_e
xternal.py --external_results_file /share3/saves/boson/image/CLoSD_dancing/output/aistpp_concat_ng40/sample/generated_motions.npy --eval_gt
[INFO] Loading ground truth motions (gt_motion)
[INFO] Loaded 1000 paired audio waveforms from npy file
[INFO] Using 1000 paired audio waveforms for beat alignment
[DEBUG] _get_gt_batch_with_audio: calling get_dataset_loader...
Fetching 52 files: 100%|???????????????????????????????????????????????????????????????????????????????????????????????????????| 52/52 [00:00<00:00, 47840.27it/s]
Data dependencies are cached at [/share2/huggingface/hub/models--guytevet--CLoSD/snapshots/de7106b947b6f70700b5320d1cd61fef4a9ebc9b]
[DEBUG] _get_gt_batch_with_audio: loader created, getting first batch...
[DEBUG] _get_gt_batch_with_audio: got batch!
Fetching 52 files: 100%|???????????????????????????????????????????????????????????????????????????????????????????????????????| 52/52 [00:00<00:00, 20103.59it/s]
Data dependencies are cached at [/share2/huggingface/hub/models--guytevet--CLoSD/snapshots/de7106b947b6f70700b5320d1cd61fef4a9ebc9b]
Loading Evaluation Model Wrapper (Epoch 11) Completed!!
[INFO] Loaded motion mean/std from closd/diffusion_planner/dataset
=== AIST++ external eval ===
external_results_file: /share3/saves/boson/image/CLoSD_dancing/output/aistpp_concat_ng40/sample/generated_motions.npy
num_samples: 1000
FID: 0.0535
Diversity: 5.3355
BeatAlign: 0.3853 (computed on 1000 samples with audio)
SkatingRatio(mean): 0.0083
FootSliding(mm): 0.0538
Penetration(mm): 0.0000
Floating(mm): 59.1546

conda activate closd && CUDA_VISIBLE_DEVICES=5 python closd/diffusion_planner/eval/eval_aistpp_external.py --external_results_file /share3/saves/boson/image/CLoSD_dancing/output/aistpp_concat_ng40/sample/generated_motions.npy
[INFO] Loaded 1000 paired audio waveforms from npy file
[INFO] Using 1000 paired audio waveforms for beat alignment
[DEBUG] _get_gt_batch_with_audio: calling get_dataset_loader...
Fetching 52 files: 100%|??????????????????????????????????????????????????????????????????????????????????????????????????????| 52/52 [00:00<00:00, 297956.02it/s]
Data dependencies are cached at [/share2/huggingface/hub/models--guytevet--CLoSD/snapshots/de7106b947b6f70700b5320d1cd61fef4a9ebc9b]
[DEBUG] _get_gt_batch_with_audio: loader created, getting first batch...
[DEBUG] _get_gt_batch_with_audio: got batch!
Fetching 52 files: 100%|???????????????????????????????????????????????????????????????????????????????????????????????????????| 52/52 [00:00<00:00, 16124.78it/s]
Data dependencies are cached at [/share2/huggingface/hub/models--guytevet--CLoSD/snapshots/de7106b947b6f70700b5320d1cd61fef4a9ebc9b]
Loading Evaluation Model Wrapper (Epoch 11) Completed!!
[INFO] Loaded motion mean/std from closd/diffusion_planner/dataset
=== AIST++ external eval ===
external_results_file: /share3/saves/boson/image/CLoSD_dancing/output/aistpp_concat_ng40/sample/generated_motions.npy
num_samples: 1000
FID: 18.2840
Diversity: 4.3523
BeatAlign: 0.3834 (computed on 1000 samples with audio)
SkatingRatio(mean): 0.0486
FootSliding(mm): 2.3931
Penetration(mm): 1.6065
Floating(mm): 242.1510

conda activate closd && CUDA_VISIBLE_DEVICES=5 python closd/diffusion_planner/eval/eval_aistpp_external.py --external_results_file /share3/saves/boson/image/CLoSD_dancing/output/aistpp_concat_ng80/sample/generated_motions.npy
[INFO] Loaded 1000 paired audio waveforms from npy file
[INFO] Using 1000 paired audio waveforms for beat alignment
[DEBUG] _get_gt_batch_with_audio: calling get_dataset_loader...
Fetching 52 files: 100%|???????????????????????????????????????????????????????????????????????????????????????????????????????| 52/52 [00:00<00:00, 39705.77it/s]
Data dependencies are cached at [/share2/huggingface/hub/models--guytevet--CLoSD/snapshots/de7106b947b6f70700b5320d1cd61fef4a9ebc9b]
[DEBUG] _get_gt_batch_with_audio: loader created, getting first batch...
[DEBUG] _get_gt_batch_with_audio: got batch!
Fetching 52 files: 100%|???????????????????????????????????????????????????????????????????????????????????????????????????????| 52/52 [00:00<00:00, 10767.90it/s]
Data dependencies are cached at [/share2/huggingface/hub/models--guytevet--CLoSD/snapshots/de7106b947b6f70700b5320d1cd61fef4a9ebc9b]
Loading Evaluation Model Wrapper (Epoch 11) Completed!!
[INFO] Loaded motion mean/std from closd/diffusion_planner/dataset
=== AIST++ external eval ===
external_results_file: /share3/saves/boson/image/CLoSD_dancing/output/aistpp_concat_ng80/sample/generated_motions.npy
num_samples: 1000
FID: 11.7527
Diversity: 3.6255
BeatAlign: 0.3873 (computed on 1000 samples with audio)
SkatingRatio(mean): 0.0087
FootSliding(mm): 0.2495
Penetration(mm): 0.1466
Floating(mm): 169.4469

| ???? (Model) | ???? | FID (?) | Diversity | BeatAlign (?) | Skating Ratio (?) | Floating (mm) (?) | ???? |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| **GT (Ground Truth)** | - | **0.0535** | 5.34 | 0.3853 | **0.0083** | 59.2 | ?????? |
| **CLoSD (Physics)** | ng40 | **5.0655** | 3.58 | 0.3727* | 0.0176 | **23.9** | *????? (Random) |
| **Raw Diffusion** | ng20 | 16.17 | 4.62 | 0.3852 | 0.0152 | 249.8 | ????? |
| **Raw Diffusion** | ng40 | 18.28 | 4.35 | 0.3834 | 0.0486 | 242.2 | ?????? |
| **Raw Diffusion** | ng80 | 11.75 | 3.63 | **0.3873** | 0.0087 | 169.4 | ????? |

---

### ?????????

#### 1. CLoSD (????) vs. Raw Diffusion (????)
?????????
*   **????????:**
    *   **Floating (??):** ???????ng20/40?????? **240mm+**???????????CLoSD ????? **23.9mm**??????GT ???? 59.2mm????? CLoSD ????????????????????????????? CLoSD ????????????
    *   **FID (???):** CLoSD ? FID (**5.07**) ??????????11~18????????????????????????????????????
*   **BeatAlign (??) ???:**
    *   Log ?? `[WARN] No paired audio... using random audio`??? CLoSD ? BeatAlign ?? (0.3727) **??????**??? CLoSD ??? ng40 ????????????????? ng40??????????????????????

#### 2. ??????? (ng20 vs ng40 vs ng80)
???????????????**???**????

*   **FID (????):**
    *   ???ng20 (16.17) -> ng40 (18.28) -> **ng80 (11.75)**
    *   **??:** ????????????????????????? **ng80 ????**?
    *   **????:** AIST++ ?????????????Phrase??ng20 ????????????????? evaluator ?????????ng40 ??????????????? ng80 ?????????? Transformer ??????????????????????????

*   **Physics Metrics (?????):**
    *   **Skating (??):** ng80 ???? (**0.0087**) ???????? GT (**0.0083**) ????????????????????????????? ng40 ????????? (0.0486)?
    *   **Floating (??):** ?? ng80 (169mm) ??? GT ?????? ng20/40 (240mm+) ??????????????????????????

*   **BeatAlign (????):**
    *   ?? Raw Diffusion ??????? (~0.385)?? GT ???
    *   **ng80 (0.3873)** ????? GT (0.3853)?????? Diffusion Transformer ??????????????????????????????????????????????????????

#### 3. Ground Truth (GT) ?????
*   **FID ~ 0:** ????????????
*   **Floating ~ 59mm:** ?????????????????0mm????????????????CLoSD ? 23mm ?????????????? Raw ? 169mm~249mm ????????????

### ????

1.  **?? Raw ??:** **ng80** ???????????????? FID?Skating Ratio ? BeatAlign ???? ng20 ? ng40???????????????????Long-term dependency????????
2.  **????????:** ?? ng80 ???????? Floating (169mm) ???????????????**CLoSD** ????????????????? FID ? 11~18 ?? 5 ?????? SOTA ??????????
3.  **???:** ??????????BeatAlign ? GT ?????? Diffusion ????????